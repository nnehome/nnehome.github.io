


<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Code &#8212; NNE  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=927b94d3fcb96560df09" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=927b94d3fcb96560df09" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=927b94d3fcb96560df09" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=927b94d3fcb96560df09" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=39c899d2" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=927b94d3fcb96560df09" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=927b94d3fcb96560df09" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=927b94d3fcb96560df09"></script>

    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'code/code';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Welcome to NNE" href="../home/home.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">
   

<a class="navbar-brand logo" href="https://nnehome.github.io">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
    <p class="title logo__title">NNE</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../home/home.html">
                         Home
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                         Code
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../home/home.html">
                         Home
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                         Code
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Code</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="code">
<span id="id1"></span><h1>Code<a class="headerlink" href="#code" title="Link to this heading">#</a></h1>
<p>All Matlab codes can be found on the <a class="reference external" href="https://github.com/nnehome/nne-matlab" rel="noopener noreferrer" target="_blank">GitHub</a> page.
On the home page, we describe the two key functions <code class="docutils literal notranslate"><span class="pre">nne_gen.m</span></code> and <code class="docutils literal notranslate"><span class="pre">nne_train.m</span></code> to implement NNE.
On this page, we describe the other accompanying functions and files used in the estimation.</p>
<section id="nne-estimation">
<h2>NNE estimation<a class="headerlink" href="#nne-estimation" title="Link to this heading">#</a></h2>
<section id="moments-m">
<h3><code class="docutils literal notranslate"><span class="pre">Moments.m</span></code><a class="headerlink" href="#moments-m" title="Link to this heading">#</a></h3>
<p>This function summarizes data into data moments which serve as inputs into neural net estimation. It can be adapted to other structural models.</p>
<details class="summary-collapse-header2-show-collapse-header-moments-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>Moments.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>output<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">Moments</span><span class="p">(</span>pos, z, consumer_id, yd, yt, type<span class="p">)</span>

<span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">];</span><span class="w"> </span><span class="c">% outcome; search+purchase</span>
<span class="n">x</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pos</span><span class="p">)];</span><span class="w"> </span><span class="c">% covariates + position</span>

<span class="n">ydn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">accumarray</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yd</span><span class="p">);</span><span class="w">  </span><span class="c">% number of searches</span>
<span class="n">ytn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">accumarray</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">);</span><span class="w">  </span><span class="c">% whether bought inside goods</span>

<span class="n">y_tilde</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">ydn</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ydn</span><span class="p">,</span><span class="w"> </span><span class="n">ytn</span><span class="p">];</span>

<span class="n">x_tilde</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">splitapply</span><span class="p">(@</span><span class="nb">mean</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">consumer_id</span><span class="p">);</span>

<span class="c">% if not specified, use type 4, which is the main specification</span>
<span class="k">if</span><span class="w"> </span><span class="nb">exist</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;var&#39;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>

<span class="w">    </span><span class="nb">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="k">end</span>


<span class="k">if</span><span class="w"> </span><span class="nb">type</span><span class="o">==</span><span class="mi">1</span>

<span class="w">    </span><span class="n">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m2</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="n">m2</span><span class="p">];</span>

<span class="k">elseif</span><span class="w"> </span><span class="nb">type</span><span class="o">==</span><span class="mi">2</span>

<span class="w">    </span><span class="n">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m2</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">([</span><span class="n">ydn</span><span class="p">,</span><span class="w"> </span><span class="n">ytn</span><span class="p">]);</span>
<span class="w">    </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">([</span><span class="n">ydn</span><span class="p">,</span><span class="w"> </span><span class="n">ytn</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">([</span><span class="n">ydn</span><span class="p">,</span><span class="w"> </span><span class="n">ytn</span><span class="p">]))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m4</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="n">m2</span><span class="p">,</span><span class="w"> </span><span class="n">m3</span><span class="p">,</span><span class="w"> </span><span class="n">m4</span><span class="p">];</span>

<span class="k">elseif</span><span class="w"> </span><span class="nb">type</span><span class="o">==</span><span class="mi">3</span>

<span class="w">    </span><span class="n">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m2</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">);</span>
<span class="w">    </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m4</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="n">m2</span><span class="p">,</span><span class="w"> </span><span class="n">m3</span><span class="p">,</span><span class="w"> </span><span class="n">m4</span><span class="p">];</span>

<span class="k">elseif</span><span class="w"> </span><span class="nb">type</span><span class="o">==</span><span class="mi">4</span><span class="w"> </span><span class="c">% main specification</span>

<span class="w">    </span><span class="n">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m2</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">);</span>
<span class="w">    </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m4</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cov</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">);</span><span class="w"> </span><span class="n">m5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m5</span><span class="p">(</span><span class="nb">tril</span><span class="p">(</span><span class="nb">true</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">m5</span><span class="p">))))</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="n">m2</span><span class="p">,</span><span class="w"> </span><span class="n">m3</span><span class="p">,</span><span class="w"> </span><span class="n">m4</span><span class="p">,</span><span class="w"> </span><span class="n">m5</span><span class="p">];</span>

<span class="k">elseif</span><span class="w"> </span><span class="nb">type</span><span class="o">==</span><span class="mi">5</span>

<span class="w">    </span><span class="n">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m2</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">);</span>
<span class="w">    </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m4</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cov</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">);</span><span class="w"> </span><span class="n">m5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m5</span><span class="p">(</span><span class="nb">tril</span><span class="p">(</span><span class="nb">true</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">m5</span><span class="p">))))</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="o">.^</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m6</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="n">m2</span><span class="p">,</span><span class="w"> </span><span class="n">m3</span><span class="p">,</span><span class="w"> </span><span class="n">m4</span><span class="p">,</span><span class="w"> </span><span class="n">m5</span><span class="p">,</span><span class="w"> </span><span class="n">m6</span><span class="p">];</span>

<span class="k">elseif</span><span class="w"> </span><span class="nb">type</span><span class="o">==</span><span class="mi">6</span>

<span class="w">    </span><span class="n">m1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m2</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">);</span>
<span class="w">    </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m4</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cov</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">);</span><span class="w"> </span><span class="n">m5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m5</span><span class="p">(</span><span class="nb">tril</span><span class="p">(</span><span class="nb">true</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">m5</span><span class="p">))))</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x</span><span class="o">.^</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m6</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">m7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">y_tilde</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">y_tilde</span><span class="p">))</span><span class="o">&#39;*</span><span class="p">(</span><span class="n">x_tilde</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">x_tilde</span><span class="o">.^</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">m7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m7</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="n">m2</span><span class="p">,</span><span class="w"> </span><span class="n">m3</span><span class="p">,</span><span class="w"> </span><span class="n">m4</span><span class="p">,</span><span class="w"> </span><span class="n">m5</span><span class="p">,</span><span class="w"> </span><span class="n">m6</span><span class="p">,</span><span class="w"> </span><span class="n">m7</span><span class="p">];</span>
<span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
</details><p>inputs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pos</span></code>: ranking position of the option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">z</span></code>: product observables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">consumer_id</span></code>: consumer id</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">yd</span></code>: dummy variable denoting consumer clicking outcome</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">yt</span></code>: dummy variable denoting consumer purchase outcome</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code>: denote the different type of moments. Type=4 is the main specification. Type 1 to 6 calculates 16,32,40,46,60 and 81 number of moments (as in Table 5 of the paper).</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="predsummary-m">
<h3><code class="docutils literal notranslate"><span class="pre">PredSummary.m</span></code><a class="headerlink" href="#predsummary-m" title="Link to this heading">#</a></h3>
<p>This function calculates the bias and rmse of the test data after training the neural network model.</p>
<details class="summary-collapse-header2-show-collapse-header-predsummary-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>PredSummary.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% measure misclassifiction rate</span>


<span class="k">function</span><span class="w"> </span>err<span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nf">PredSummary</span><span class="p">(</span>input_test, label_test, label_name, net, varargin<span class="p">)</span>

<span class="n">option</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">inputParser</span><span class="p">;</span>
<span class="n">option</span><span class="p">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s">&#39;figure&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">option</span><span class="p">.</span><span class="n">addParameter</span><span class="p">(</span><span class="s">&#39;table&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">option</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">varargin</span><span class="p">{:})</span>

<span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">label_test</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">label_test</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">label_name</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">k</span>
<span class="w">    </span><span class="n">learn_se</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">elseif</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">k</span>
<span class="w">    </span><span class="n">learn_se</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;label format not recognized,&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">y_hat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">input_test</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;acceleration&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;ExecutionEnvironment&#39;</span><span class="p">,</span><span class="s">&#39;cpu&#39;</span><span class="p">);</span>
<span class="n">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">y_hat</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">label_test</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="n">learn_se</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">y_hat</span><span class="p">(:,</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">PositiveTransform</span><span class="p">(</span><span class="n">y_hat</span><span class="p">(:,</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">));</span>
<span class="w">    </span><span class="n">sdd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">y_hat</span><span class="p">(:,</span><span class="w"> </span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">);</span>
<span class="k">end</span>

<span class="nb">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;DefaultTextInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="nb">groot</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;defaultLegendInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">,</span><span class="s">&#39;defaultAxesTickLabelInterpreter&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">)</span>

<span class="n">q</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>

<span class="c">%% plot histogram</span>

<span class="k">if</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="n">Results</span><span class="p">.</span><span class="n">figure</span>

<span class="w">    </span><span class="nb">figure</span><span class="p">(</span><span class="s">&#39;Position&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="mi">250</span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="mi">420</span><span class="p">])</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">q</span>

<span class="w">        </span><span class="nb">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="o">+</span><span class="nb">j</span><span class="p">)</span>
<span class="w">        </span><span class="nb">histogram</span><span class="p">(</span><span class="n">err</span><span class="p">(:,</span><span class="nb">j</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;EdgeColor&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;FaceColor&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mf">0.4</span><span class="w"> </span><span class="mf">0.7</span><span class="p">])</span>
<span class="w">        </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&quot;$\widehat{&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_name</span><span class="p">{</span><span class="nb">j</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;}-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_name</span><span class="p">{</span><span class="nb">j</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;$&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">axis</span><span class="w"> </span><span class="n">tight</span>
<span class="w">        </span><span class="nb">ylim</span><span class="p">(</span><span class="nb">ylim</span><span class="o">*</span><span class="mf">1.1</span><span class="p">);</span>

<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">q</span>

<span class="w">        </span><span class="nb">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="nb">j</span><span class="p">)</span>
<span class="w">        </span><span class="nb">scatter</span><span class="p">(</span><span class="n">label_test</span><span class="p">(:,</span><span class="nb">j</span><span class="p">),</span><span class="w"> </span><span class="n">err</span><span class="p">(:,</span><span class="nb">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_test</span><span class="p">(:,</span><span class="nb">j</span><span class="p">),</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mf">0.4</span><span class="w"> </span><span class="mf">0.7</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;.&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="n">line45</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">refline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">line45</span><span class="p">.</span><span class="n">Color</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;r&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="nb">ylabel</span><span class="p">({</span><span class="s">&quot; &quot;</span><span class="p">;</span><span class="s">&quot; &quot;</span><span class="p">;</span><span class="s">&quot;$\widehat{&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_name</span><span class="p">{</span><span class="nb">j</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;}$&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="nb">xlabel</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_name</span><span class="p">{</span><span class="nb">j</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;$&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">axis</span><span class="w"> </span><span class="n">tight</span>
<span class="w">        </span><span class="nb">box</span><span class="w"> </span><span class="n">on</span>

<span class="w">    </span><span class="k">end</span>

<span class="k">end</span>

<span class="c">%% print result table</span>

<span class="k">if</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="n">Results</span><span class="p">.</span><span class="n">table</span>

<span class="w">    </span><span class="n">bias</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">num2str</span><span class="p">(</span><span class="nb">mean</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; (&quot;</span><span class="o">+</span><span class="nb">num2str</span><span class="p">(</span><span class="nb">std</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">&#39;/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">rmse</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">num2str</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">mean</span><span class="p">(</span><span class="n">err</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="o">&#39;</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; (&quot;</span><span class="o">+</span><span class="nb">num2str</span><span class="p">(</span><span class="mf">.5</span><span class="o">./</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">mean</span><span class="p">(</span><span class="n">err</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="o">&#39;</span><span class="p">)</span><span class="o">.*</span><span class="nb">std</span><span class="p">(</span><span class="n">err</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="o">&#39;/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">learn_se</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">mean_SD</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">num2str</span><span class="p">(</span><span class="n">nan</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">mean_SD</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">num2str</span><span class="p">(</span><span class="nb">mean</span><span class="p">(</span><span class="n">sdd</span><span class="p">)</span><span class="o">&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; (&quot;</span><span class="o">+</span><span class="nb">num2str</span><span class="p">(</span><span class="nb">std</span><span class="p">(</span><span class="n">sdd</span><span class="p">)</span><span class="o">&#39;/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">bias</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="n">bias</span><span class="p">);</span>
<span class="w">    </span><span class="n">rmse</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="n">rmse</span><span class="p">);</span>
<span class="w">    </span><span class="n">mean_SD</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="n">mean_SD</span><span class="p">);</span>

<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">table</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span><span class="w"> </span><span class="n">rmse</span><span class="p">,</span><span class="w"> </span><span class="n">mean_SD</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;RowNames&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">label_name</span><span class="p">);</span>
<span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">end</span>
</pre></div>
</div>
</details><p>inputs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">input_test</span></code>: moment input in the test set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label_test</span></code>: label output in the test set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label_name</span></code>: name of the label</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">net</span></code>: trained neural net</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">figure</span></code> (1/0): optional input to show figure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">table</span></code> (1/0): optional input to show table</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="statistics-m">
<h3><code class="docutils literal notranslate"><span class="pre">Statistics.m</span></code><a class="headerlink" href="#statistics-m" title="Link to this heading">#</a></h3>
<p>This function calculates the summary statistics of the search data.</p>
<details class="summary-collapse-header2-show-collapse-header-statistics-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>Statistics.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="nf">[buy_rate, search_rate, num_search, pos_search] = Statistics</span><span class="p">(</span>yd, yt, pos, consumer_id, display<span class="p">)</span>

<span class="c">% index = find(X(:,end));</span>

<span class="n">ydn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">accumarray</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yd</span><span class="p">);</span>
<span class="n">ytn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">accumarray</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">);</span>

<span class="n">buy_rate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">ytn</span><span class="p">);</span>
<span class="n">search_rate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="w"> </span><span class="n">ydn</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">num_search</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">ydn</span><span class="p">);</span>
<span class="n">search_position</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pos</span><span class="p">(</span><span class="n">yd</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span>
<span class="n">pos_search</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">search_position</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="nb">display</span>
<span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="s">&quot;Frequency of buying: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buy_rate</span><span class="p">)</span>
<span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="s">&quot;Frequency of search: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">search_rate</span><span class="p">)</span>
<span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="s">&quot;Average number of searches: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_search</span><span class="p">)</span>
<span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="s">&quot;Average position of searches: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos_search</span><span class="p">)</span>

<span class="k">end</span>
<span class="c">% accumarray(pos, yd)</span>
<span class="c">% tabulate(ydn)</span>
</pre></div>
</div>
</details><div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="gen-seq-search-m">
<h3><code class="docutils literal notranslate"><span class="pre">gen_seq_search.m</span></code><a class="headerlink" href="#gen-seq-search-m" title="Link to this heading">#</a></h3>
<p>This function generates outcomes based on observables and error draws. It is specific to sequential search model and can be adapted to other structural models.
This function is adapted from the replication code of Ursu “The Power of Rankings”.</p>
<details class="summary-collapse-header2-show-collapse-header-gen-seq-search-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>gen_seq_search.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="nf">[yd, yt, order] = gen_seq_search</span><span class="p">(</span>pos, X, consumer_id, theta, eps, eps0, curve<span class="p">)</span>
<span class="c">%% setup</span>

<span class="c">% number of options for each consumer</span>
<span class="n">Ji</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">accumarray</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">Ji</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Ji</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">);</span>

<span class="n">bepos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">theta</span><span class="p">(</span><span class="k">end</span><span class="p">);</span><span class="w"> </span><span class="c">% last par, position</span>
<span class="n">constc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">theta</span><span class="p">(</span><span class="k">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c">% par (2nd to last): constant in search cost</span>

<span class="n">v0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">theta</span><span class="p">(</span><span class="k">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c">% outside option</span>

<span class="n">rows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">);</span><span class="w"> </span><span class="c">% number of observations</span>
<span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">(</span><span class="n">rows</span><span class="p">);</span><span class="w"> </span><span class="c">% number of consumers</span>

<span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ismember</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">);</span><span class="w"> </span><span class="c">% index of consumers in the data</span>

<span class="c">%form utility from data and param</span>
<span class="n">eutility</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">theta</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">&#39;</span><span class="p">;</span>

<span class="n">utility</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eutility</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">eps</span><span class="p">;</span>

<span class="c">% utility of the outside option</span>
<span class="n">u0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">v0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eps0</span><span class="p">;</span>

<span class="c">%search cost</span>
<span class="c">% c, and therefore m, only changes with pos</span>
<span class="n">sz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">pos_unique</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sort</span><span class="p">(</span><span class="nb">unique</span><span class="p">(</span><span class="n">pos</span><span class="p">));</span>
<span class="n">m_pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">pos_unique</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">pos_unique</span><span class="p">)</span>
<span class="c">%     c_i = exp(constc + i.*bepos);</span>
<span class="w">    </span><span class="n">c_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">constc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">.*</span><span class="n">bepos</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">c_i</span><span class="o">&lt;</span><span class="n">curve</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_i</span><span class="o">&gt;=</span><span class="n">curve</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">c_i</span><span class="p">)</span>
<span class="w">                </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">((</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="n">c_i</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">c_i</span><span class="o">&gt;</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="w">                </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="n">c_i</span><span class="o">&gt;=</span><span class="n">curve</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="n">c_i</span><span class="p">;</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="n">c_i</span><span class="o">&lt;</span><span class="n">curve</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">4.001</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
<span class="n">m</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>

<span class="c">%reservation utilities</span>
<span class="n">z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eutility</span><span class="p">;</span>

<span class="c">%order by z for each consumer</span>
<span class="n">da</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">Ji</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">utility</span><span class="p">,</span><span class="w"> </span><span class="n">eutility</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">];</span>
<span class="n">whatz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">da</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="n">whateu</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">whatz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">whatu</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">whateu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="n">order</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="w">    </span><span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Ji</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="c">%     for j = n:n+J-1</span>
<span class="w">    </span><span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sort</span><span class="p">(</span><span class="n">da</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">whatz</span><span class="p">),</span><span class="s">&#39;descend&#39;</span><span class="p">);</span>
<span class="c">%     end</span>
<span class="k">end</span>

<span class="n">o</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="w">    </span><span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Ji</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span>
<span class="w">        </span><span class="n">o</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">order</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">da</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="p">:);</span>

<span class="c">% click decisions</span>
<span class="n">yd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">ydn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>


<span class="c">% order of clicks</span>
<span class="n">order</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="c">% free first click</span>
<span class="n">yd</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="c">%for next click decisions: if z is higher than outside</span>
<span class="c">%option and higher than all utilities so far, then increase click d by one</span>
<span class="c">% It is ok to do this because we ordered the z&#39;s first, so we know that zn&gt;zn+1</span>
<span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<span class="w">    </span><span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Ji</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:(</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">ma</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">):(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">whatu</span><span class="p">),</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="nb">i</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="nb">j</span><span class="p">,</span><span class="w"> </span><span class="n">whatz</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ma</span>
<span class="w">            </span><span class="n">yd</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="nb">j</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">ydn</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">):(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">yd</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">):(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">)));</span>
<span class="k">end</span>

<span class="c">%tran decisions: if out of those clicked (the set of indices from first to</span>
<span class="c">%max) u=max, then put a 1, otherwise put zero; finally reshape</span>
<span class="n">yt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">mi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<span class="w">    </span><span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Ji</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">));</span>
<span class="w">    </span><span class="n">ydn_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ydn</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">));</span>
<span class="c">%     if ydn_i&gt;0</span>
<span class="w">        </span><span class="n">order</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">):</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="n">ydn_i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">ydn_i</span><span class="p">;</span>
<span class="c">%     end</span>
<span class="w">    </span><span class="n">mi</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">):</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">max</span><span class="p">([</span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">):</span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">+</span><span class="n">ydn_i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">whatu</span><span class="p">);</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="nb">i</span><span class="p">)]);</span>
<span class="k">end</span>
<span class="n">yt</span><span class="p">(</span><span class="n">data</span><span class="p">(:,</span><span class="w"> </span><span class="n">whatu</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mi</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="w"> </span><span class="nb">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ismember</span><span class="p">((</span><span class="mi">1</span><span class="p">:</span><span class="n">rows</span><span class="p">)</span><span class="o">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">);</span>
<span class="n">yd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">yd</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
<span class="n">yt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">yt</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
<span class="n">order</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">order</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>

<span class="k">end</span>
</pre></div>
</div>
</details><p>input:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pos</span></code>: ranking position of the option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">X</span></code>: product observables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">consumer_id</span></code>: consumer id</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">theta</span></code>: parameter value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eps</span></code>: error draw for the utility of the options</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eps0</span></code>: error draw for the outside option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">curve</span></code>: a table that stores the standardized search cost and the corresponding reservation utility</p></li>
</ul>
<p>output:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">yd</span></code>: dummy variable denoting consumer clicking outcome</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">yt</span></code>: dummy variable denoting consumer purchase outcome</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">order</span></code>: order of search</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="normalregressionlayer-m">
<h3><code class="docutils literal notranslate"><span class="pre">normalRegressionLayer.m</span></code><a class="headerlink" href="#normalregressionlayer-m" title="Link to this heading">#</a></h3>
<p>This function is a custom neural net layer which defines the loss function used in neural net training. It is used as the last layer of the neural net <code class="docutils literal notranslate"><span class="pre">layers</span></code>.
<code class="docutils literal notranslate"><span class="pre">forwardLoss</span></code> function specifies the loss between predictions and the training targets. Two types of loss function can be used in NNE.
If <code class="docutils literal notranslate"><span class="pre">learn_standard_error</span> <span class="pre">=</span> <span class="pre">false</span></code>, NNE uses the mean squared error loss (<span class="math notranslate nohighlight">\({C_1(f)}\)</span> in Eq 5 in the paper). If <code class="docutils literal notranslate"><span class="pre">learn_standard_error</span> <span class="pre">=</span> <span class="pre">true</span></code>, NNE uses the cross-entropy
loss (<span class="math notranslate nohighlight">\({C_2(f)}\)</span> in Eq 6 in the paper). <code class="docutils literal notranslate"><span class="pre">backwardLoss</span></code> function specifies the derivative of the loss with respect to the predictions. When <code class="docutils literal notranslate"><span class="pre">learn_standard_error</span> <span class="pre">=</span> <span class="pre">true</span></code>,
NNE predicts both the point estimates and the standard deviations.</p>
<details class="summary-collapse-header2-show-collapse-header-normalregressionlayer-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>normalRegressionLayer.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">classdef</span><span class="w"> </span><span class="n">normalRegressionLayer</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nnet</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">RegressionLayer</span>

<span class="w">    </span><span class="k">properties</span>
<span class="w">        </span><span class="c">% (Optional) Layer properties.</span>

<span class="w">        </span><span class="n">Simple</span>

<span class="w">        </span><span class="c">% Layer properties go here.</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">methods</span>

<span class="w">        </span><span class="k">function</span><span class="w"> </span>layer<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">normalRegressionLayer</span><span class="p">(</span>varargin<span class="p">)</span>

<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">inputParser</span><span class="p">;</span>
<span class="w">            </span><span class="n">addOptional</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;simple&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="nb">islogical</span><span class="p">)</span>
<span class="w">            </span><span class="n">parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">{:})</span>

<span class="w">            </span><span class="n">layer</span><span class="p">.</span><span class="n">Simple</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Results</span><span class="p">.</span><span class="n">simple</span><span class="p">;</span>

<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">function</span><span class="w"> </span>loss<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">forwardLoss</span><span class="p">(</span>layer, Y, T<span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">layer</span><span class="p">.</span><span class="n">Simple</span>

<span class="w">                </span><span class="n">Q</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">;</span>

<span class="w">            </span><span class="k">else</span>

<span class="w">                </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

<span class="w">                </span><span class="p">[</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">PositiveTransform</span><span class="p">(</span><span class="n">Y</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p">:));</span>
<span class="w">                </span><span class="n">U</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p">:);</span>
<span class="w">                </span><span class="n">X</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p">:);</span>

<span class="w">                </span><span class="n">Q</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">U</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X</span><span class="p">)</span><span class="o">./</span><span class="n">S</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">;</span>

<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="n">loss</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">Q</span><span class="p">(:))</span><span class="o">/</span><span class="nb">size</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">function</span><span class="w"> </span>dLdY<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">backwardLoss</span><span class="p">(</span>layer, Y, T<span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">layer</span><span class="p">.</span><span class="n">Simple</span>

<span class="w">                </span><span class="n">dLdY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="nb">size</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

<span class="w">                </span><span class="p">[</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">dS</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">PositiveTransform</span><span class="p">(</span><span class="n">Y</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p">:));</span>
<span class="w">                </span><span class="n">U</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p">:);</span>
<span class="w">                </span><span class="n">X</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p">:);</span>

<span class="w">                </span><span class="n">dLdS</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="o">./</span><span class="n">S</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">./</span><span class="n">S</span><span class="o">.^</span><span class="mi">3</span><span class="o">.*</span><span class="p">(</span><span class="n">U</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">;</span>
<span class="w">                </span><span class="n">dLdU</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">U</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X</span><span class="p">)</span><span class="o">./</span><span class="n">S</span><span class="o">.^</span><span class="mi">2</span><span class="p">;</span>

<span class="w">                </span><span class="n">dLdY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">dLdU</span><span class="p">;</span><span class="w"> </span><span class="n">dLdS</span><span class="o">.*</span><span class="n">dS</span><span class="p">]</span><span class="o">/</span><span class="nb">size</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</details><div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="positivetransform-m">
<h3><code class="docutils literal notranslate"><span class="pre">PositiveTransform.m</span></code><a class="headerlink" href="#positivetransform-m" title="Link to this heading">#</a></h3>
<p>This function is used in <code class="docutils literal notranslate"><span class="pre">normalRegressionLayer.m</span></code> to transform to positive numbers for the variance terms.</p>
<details class="summary-collapse-header2-show-collapse-header-positivetransform-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>PositiveTransform.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="nf">[value, derivative] = PositiveTransform</span><span class="p">(</span>x<span class="p">)</span>

<span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">derivative</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
</pre></div>
</div>
</details><div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="set-up-m">
<h3><code class="docutils literal notranslate"><span class="pre">set_up.m</span></code><a class="headerlink" href="#set-up-m" title="Link to this heading">#</a></h3>
<p>This function generates the Monte Carlo data for sequential search models, which is not needed when estimating a real dataset.
It also defines the bounds from which to draw <span class="math notranslate nohighlight">\(\theta^{(l)}\)</span>.</p>
<details class="summary-collapse-header2-show-collapse-header-set-up-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>set_up.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">%% config</span>

<span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="c">% number of consumers</span>
<span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w"> </span><span class="c">% options per consumer</span>

<span class="c">% z dim = 7, the same as the empirical data</span>
<span class="nb">bounds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="mf">0.1</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="s">&#39;\beta_1&#39;</span><span class="w">       </span><span class="c">% coefficient (stars)</span>
<span class="w">            </span><span class="mf">0.0</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="s">&#39;\beta_2&#39;</span><span class="w">       </span><span class="c">% coefficient (review score)</span>
<span class="w">            </span><span class="mf">0.2</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="s">&#39;\beta_3&#39;</span><span class="w">       </span><span class="c">% coefficient (loc score)</span>
<span class="w">        </span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="mf">0.5</span><span class="p">,</span><span class="w">     </span><span class="s">&#39;\beta_4&#39;</span><span class="w">       </span><span class="c">% coefficient (chain)</span>
<span class="w">            </span><span class="mf">0.2</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="s">&#39;\beta_5&#39;</span><span class="w">       </span><span class="c">% coefficient (promotion)</span>
<span class="w">        </span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="mf">0.5</span><span class="p">,</span><span class="w">  </span><span class="s">&#39;\beta_6&#39;</span><span class="w">          </span><span class="c">% coefficient (price)</span>
<span class="w">            </span><span class="mf">3.0</span><span class="p">,</span><span class="w">    </span><span class="mf">2.0</span><span class="p">,</span><span class="w">  </span><span class="mf">5.0</span><span class="p">,</span><span class="w">  </span><span class="s">&#39;\eta&#39;</span><span class="w">          </span><span class="c">% outside good</span>
<span class="w">        </span><span class="o">-</span><span class="mf">4.0</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="w">  </span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span><span class="w">    </span><span class="s">&#39;\delta_0&#39;</span><span class="w">      </span><span class="c">% search cost base</span>
<span class="w">            </span><span class="mf">0.1</span><span class="p">,</span><span class="w">   </span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span><span class="w">  </span><span class="mf">0.25</span><span class="p">,</span><span class="s">&#39;\delta_1&#39;</span><span class="w">  </span><span class="c">% search cost position</span>
<span class="w">        </span><span class="p">};</span>

<span class="n">theta_true</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="nb">bounds</span><span class="p">(:,</span><span class="mi">1</span><span class="p">))</span><span class="o">&#39;</span><span class="p">;</span>
<span class="n">lb</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="nb">bounds</span><span class="p">(:,</span><span class="mi">2</span><span class="p">))</span><span class="o">&#39;</span><span class="p">;</span>
<span class="n">ub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="nb">bounds</span><span class="p">(:,</span><span class="mi">3</span><span class="p">))</span><span class="o">&#39;</span><span class="p">;</span>
<span class="n">label_name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">bounds</span><span class="p">(:,</span><span class="mi">4</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>

<span class="c">%% simulate data</span>

<span class="n">curve</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">importdata</span><span class="p">(</span><span class="s">&#39;tableData.csv&#39;</span><span class="p">);</span>

<span class="n">rows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">N</span><span class="o">*</span><span class="n">J</span><span class="p">;</span>

<span class="n">outside</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">J</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">outside</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">J</span><span class="p">:</span><span class="n">N</span><span class="o">*</span><span class="n">J</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="c">% draw the hotel characteristics z</span>
<span class="n">z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">randsample</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mf">0.25</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">])</span><span class="o">&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="n">randsample</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mf">3.5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mf">4.5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.08</span><span class="p">,</span><span class="w"> </span><span class="mf">0.17</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">])</span><span class="o">&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.3</span><span class="o">*</span><span class="nb">randn</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="k">...</span>
<span class="w">    </span><span class="n">randsample</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p">])</span><span class="o">&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="n">randsample</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6</span><span class="p">])</span><span class="o">&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="p">(</span><span class="mf">0.15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.6</span><span class="o">*</span><span class="nb">randn</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="mi">1</span><span class="p">))];</span>

<span class="n">pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">repmat</span><span class="p">((</span><span class="mi">1</span><span class="p">:</span><span class="n">J</span><span class="p">)</span><span class="o">&#39;</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">consumer_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cumsum</span><span class="p">(</span><span class="n">outside</span><span class="p">);</span>
<span class="n">index</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">z</span><span class="p">(:,</span><span class="k">end</span><span class="p">));</span>

<span class="c">%draw eps for each consumer-firm combination</span>
<span class="nb">eps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">randn</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>

<span class="c">%draw eps for outside option</span>
<span class="n">eps0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">randn</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nb">unique</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">)),</span><span class="mi">1</span><span class="p">);</span>

<span class="p">[</span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gen_seq_search</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">theta_true</span><span class="p">,</span><span class="w"> </span><span class="nb">eps</span><span class="p">,</span><span class="w"> </span><span class="n">eps0</span><span class="p">,</span><span class="w"> </span><span class="n">curve</span><span class="p">);</span>

<span class="n">Statistics</span><span class="p">(</span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="c">%% save</span>

<span class="nb">save</span><span class="p">(</span><span class="s">&#39;data.mat&#39;</span><span class="p">,</span><span class="s">&#39;label_name&#39;</span><span class="p">,</span><span class="s">&#39;theta_true&#39;</span><span class="p">,</span><span class="s">&#39;lb&#39;</span><span class="p">,</span><span class="s">&#39;ub&#39;</span><span class="p">,</span><span class="s">&#39;consumer_id&#39;</span><span class="p">,</span><span class="s">&#39;pos&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;yd&#39;</span><span class="p">,</span><span class="s">&#39;yt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</details><div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="tabledata-csv">
<h3><code class="docutils literal notranslate"><span class="pre">tableData.csv</span></code><a class="headerlink" href="#tabledata-csv" title="Link to this heading">#</a></h3>
<p>This file stores the standardized search cost and the corresponding reservation utility.
This is specific to the estimation of sequential search model.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="smle-estimation">
<h2>SMLE estimation<a class="headerlink" href="#smle-estimation" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">tableData.csv</span></code>, <code class="docutils literal notranslate"><span class="pre">gen_seq_search.m</span></code>, <code class="docutils literal notranslate"><span class="pre">set_up.m</span></code>, <code class="docutils literal notranslate"><span class="pre">Statistics.m</span></code> are defined the same as in NNE estimation.</p>
<section id="likloutsidefe-m">
<h3><code class="docutils literal notranslate"><span class="pre">liklOutsideFE.m</span></code><a class="headerlink" href="#likloutsidefe-m" title="Link to this heading">#</a></h3>
<p>This function calculates the log-likelihood for one consumer using the smoothed likelihood approach.
The function is adapted from the replication code of Ursu “The Power of Rankings”.</p>
<details class="summary-collapse-header2-show-collapse-header-likloutsidefe-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>liklOutsideFE.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% the likelihood function is adapted from the replication code of Ursu &quot;The Power of Rankings&quot;</span>

<span class="k">function</span><span class="w"> </span>loglik<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">liklOutsideFE</span><span class="p">(</span>be, pos, X, consumer_id, yd, yt, R, w, eps_draw,eps0_draw,curve<span class="p">)</span>

<span class="n">bepos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">be</span><span class="p">(</span><span class="k">end</span><span class="p">);</span><span class="w"> </span><span class="c">% last par, position</span>
<span class="n">constc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">be</span><span class="p">(</span><span class="k">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c">% 2nd to last par: constant in search cost</span>
<span class="n">v0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">be</span><span class="p">(</span><span class="k">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c">% outside option</span>

<span class="n">Ji</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">accumarray</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c">% number of options per consumer (size N by 1)</span>

<span class="n">rows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">);</span>
<span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">(</span><span class="n">rows</span><span class="p">);</span>

<span class="c">% index of consumers in the data (size N by 1)</span>
<span class="n">index</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="nb">ischange</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">))];</span>

<span class="c">% form utility from data and param</span>
<span class="n">eutility</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">be</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">&#39;</span><span class="p">;</span>
<span class="n">utility</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">repmat</span><span class="p">(</span><span class="n">eutility</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">R</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eps_draw</span><span class="p">;</span>

<span class="c">% utility of the outside option</span>
<span class="n">u0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">v0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eps0_draw</span><span class="p">;</span>

<span class="c">% search cost &amp; reservation utility</span>
<span class="n">sz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">pos_unique</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sort</span><span class="p">(</span><span class="nb">unique</span><span class="p">(</span><span class="n">pos</span><span class="p">));</span>
<span class="n">m_pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">pos_unique</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">pos_unique</span><span class="p">)</span>
<span class="w">    </span><span class="n">c_i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">constc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="o">.*</span><span class="n">bepos</span><span class="p">);</span><span class="w"> </span><span class="c">% search cost</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">c_i</span><span class="o">&lt;</span><span class="n">curve</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_i</span><span class="o">&gt;=</span><span class="n">curve</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">c_i</span><span class="p">)</span>
<span class="w">                </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">((</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="n">c_i</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">c_i</span><span class="o">&gt;</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="w">                </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">c_i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="k">...</span>
<span class="w">                    </span><span class="o">*</span><span class="p">(</span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">curve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="n">c_i</span><span class="o">&gt;=</span><span class="n">curve</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="n">c_i</span><span class="p">;</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="n">c_i</span><span class="o">&lt;</span><span class="n">curve</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="n">m_pos</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">4.001</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
<span class="n">m</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>

<span class="c">%reservation utilities</span>
<span class="n">z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eutility</span><span class="p">;</span>

<span class="c">%%%% LIKELIHOOD %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="c">% idea: denominator = 1 + sum(w_click + w_tran)</span>
<span class="c">% probability prob = 1 / denominator</span>

<span class="c">% w_click</span>
<span class="n">denomd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">R</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">R</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
<span class="w">        </span><span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Ji</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
<span class="w">        </span><span class="c">% find entry s where last click occurs for a consumer</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">yd</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;last&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="c">% if consumer has at least one click (s&gt;1; one free search)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">J</span><span class="p">)</span>
<span class="w">            </span><span class="c">% compute ma = max utility of those searchd (incl. outside option)</span>
<span class="w">            </span><span class="n">ma</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">max</span><span class="p">([</span><span class="n">utility</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">);</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">r</span><span class="p">)]);</span>
<span class="w">            </span><span class="c">% continue to search condition</span>
<span class="w">            </span><span class="c">%1. z_searched(i) &gt; max{u_searched(i-1), u_outside}</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">r</span><span class="p">)));</span>
<span class="w">                </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;=</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                    </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">utility</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">r</span><span class="p">)));</span>
<span class="w">                    </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="c">%  stopping rules</span>
<span class="w">            </span><span class="c">%2. max u_searched &gt; z_notsearched</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="o">+</span><span class="n">s</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">ma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">z</span><span class="p">(</span><span class="n">l</span><span class="p">)));</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">J</span><span class="p">)</span>
<span class="w">            </span><span class="c">% continue to search</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">r</span><span class="p">)));</span>
<span class="w">                </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;=</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                    </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">utility</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">r</span><span class="p">)));</span>
<span class="w">                    </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">s</span><span class="o">==</span><span class="mi">1</span>
<span class="w">            </span><span class="c">% if there is only one free search</span>
<span class="w">            </span><span class="c">% max(u_outside, u1) &gt; all other z&#39;s</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="n">denomd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">utility</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">);</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span><span class="n">r</span><span class="p">)])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">z</span><span class="p">(</span><span class="n">l</span><span class="p">)));</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>


<span class="c">%w_tran</span>
<span class="n">denomt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">R</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">R</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="w">        </span><span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Ji</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="w">        </span><span class="c">%find index of tran st and of last click</span>
<span class="w">        </span><span class="n">st</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">yt</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;last&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="n">sd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">yd</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;last&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="n">kt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="w"> </span><span class="c">% no purchase</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="n">kt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="o">+</span><span class="n">sd</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="c">% outside option is better than all clicked options</span>
<span class="w">                </span><span class="n">denomt</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">denomt</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">utility</span><span class="p">(</span><span class="n">kt</span><span class="p">,</span><span class="n">r</span><span class="p">)));</span>
<span class="w">                </span><span class="n">kt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kt</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="c">% purchase option st</span>
<span class="w">            </span><span class="c">% purchased option is better than outside option</span>
<span class="w">            </span><span class="n">denomt</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">st</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">denomt</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">st</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">utility</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">st</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">r</span><span class="p">)));</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="n">kt</span><span class="o">&lt;=</span><span class="n">n</span><span class="o">+</span><span class="n">sd</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="c">% purchased option is better than all other clicked options</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">kt</span><span class="o">~=</span><span class="n">n</span><span class="o">+</span><span class="n">st</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                    </span><span class="n">denomt</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">st</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">denomt</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">st</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">utility</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">st</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">utility</span><span class="p">(</span><span class="n">kt</span><span class="p">,</span><span class="n">r</span><span class="p">)));</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="n">kt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kt</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="c">%add up search and tran partial denoms: add w_tran and w_click up</span>
<span class="n">den</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">denomd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">denomt</span><span class="p">;</span>

<span class="n">denfull</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">R</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">R</span>
<span class="w">    </span><span class="n">denfull</span><span class="p">(:,</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">accumarray</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">den</span><span class="p">(:,</span><span class="n">r</span><span class="p">));</span>
<span class="k">end</span>

<span class="c">%probability</span>
<span class="n">prob</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="o">./</span><span class="n">denfull</span><span class="p">;</span>
<span class="c">%likelihood</span>
<span class="n">loglik</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="nb">mean</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-16</span><span class="p">);</span>


<span class="k">end</span>
</pre></div>
</div>
</details><p>input:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">be</span></code>: parameter value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pos</span></code>: ranking position of the option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">X</span></code>: product observables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">consumer_id</span></code>: consumer id</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">yd</span></code>: dummy variable denoting consumer clicking outcome</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">yt</span></code>: dummy variable denoting consumer purchase outcome</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">R</span></code>: number of simulations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w</span></code>: the negative of the smoothing parameter</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eps_draw</span></code>: error draw for the utility of the options</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eps0_draw</span></code>: error draw for the outside option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">curve</span></code>: a table that stores the standardized search cost and the corresponding reservation utility</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="objective-mle-m">
<h3><code class="docutils literal notranslate"><span class="pre">Objective_mle.m</span></code><a class="headerlink" href="#objective-mle-m" title="Link to this heading">#</a></h3>
<p>This function returns the negative value of the sum of the log-likelihood by calling the <code class="docutils literal notranslate"><span class="pre">liklOutsideFE.m</span></code> function.</p>
<details class="summary-collapse-header2-show-collapse-header-objective-mle-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>Objective_mle.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>output<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">Objective_mle</span><span class="p">(</span>be, pos, X, consumer_id, yd, yt, R, w, eps_draw,eps0_draw,curve<span class="p">)</span>

<span class="n">loglik</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">liklOutsideFE</span><span class="p">(</span><span class="n">be</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">eps_draw</span><span class="p">,</span><span class="n">eps0_draw</span><span class="p">,</span><span class="n">curve</span><span class="p">);</span>

<span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">loglik</span><span class="p">);</span>

<span class="k">end</span>
</pre></div>
</div>
</details><div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="main-mle-m">
<h3><code class="docutils literal notranslate"><span class="pre">main_mle.m</span></code><a class="headerlink" href="#main-mle-m" title="Link to this heading">#</a></h3>
<p>This function implements the simulated maximum likelihood using the smoothed likelihood approach. The smoothing parameter can be set by the <code class="docutils literal notranslate"><span class="pre">w</span></code> variable.</p>
<details class="summary-collapse-header2-show-collapse-header-main-mle-m-collapse-header-code-collapse-header2">
<summary><collapse_header2>Show <collapse_header>main_mle.m</collapse_header> code</collapse_header2></summary><div class="scrollable-code-block highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">%% set up</span>

<span class="nb">clear</span><span class="p">;</span>
<span class="n">seed</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">R</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w"> </span><span class="c">% number of simulations</span>
<span class="n">w</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="c">% smoothing parameter</span>

<span class="nb">tic</span><span class="p">;</span>

<span class="nb">rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="n">set_up</span><span class="w"> </span><span class="s">%</span><span class="w"> </span><span class="s">generate</span><span class="w"> </span><span class="s">a</span><span class="w"> </span><span class="s">search</span><span class="w"> </span><span class="s">dataset,</span><span class="w"> </span><span class="s">save</span><span class="w"> </span><span class="s">in</span><span class="w"> </span><span class="s">data.mat</span>

<span class="nb">load</span><span class="p">(</span><span class="s">&#39;data.mat&#39;</span><span class="p">)</span>

<span class="c">% table with (normalized) search cost and reservation utility</span>
<span class="n">curve</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">importdata</span><span class="p">(</span><span class="s">&#39;tableData.csv&#39;</span><span class="p">);</span>

<span class="c">%% MLE  estimation for Monte Carlo</span>

<span class="c">%draw eps for each consumer-firm combination</span>
<span class="nb">eps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">randn</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
<span class="c">%draw eps for outside option</span>
<span class="n">eps0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">randn</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nb">unique</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">)),</span><span class="mi">1</span><span class="p">);</span>

<span class="c">% simulate data</span>
<span class="p">[</span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gen_seq_search</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">theta_true</span><span class="p">,</span><span class="w"> </span><span class="nb">eps</span><span class="p">,</span><span class="w"> </span><span class="n">eps0</span><span class="p">,</span><span class="w"> </span><span class="n">curve</span><span class="p">);</span>

<span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">];</span>
<span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sortrows</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">]);</span><span class="w"> </span><span class="c">% sort by consumer_id and order of clicks</span>

<span class="n">yd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">(:,</span><span class="w"> </span><span class="k">end</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="n">yt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">(:,</span><span class="w"> </span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="n">pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">(:,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="n">z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">(:,</span><span class="mi">3</span><span class="p">:(</span><span class="mi">2</span><span class="o">+</span><span class="nb">size</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">2</span><span class="p">)));</span>

<span class="c">%draw eps for each consumer-firm combination</span>
<span class="n">eps_draw</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">randn</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">),</span><span class="n">R</span><span class="p">);</span>
<span class="c">%draw eps for outside option</span>
<span class="n">eps0_draw</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">randn</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nb">unique</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">)),</span><span class="n">R</span><span class="p">);</span>

<span class="c">%initial parameter vector</span>
<span class="n">be0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">ub</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lb</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

<span class="c">% options for estimation</span>
<span class="n">options</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">optimoptions</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;fmincon&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;Display&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;iter&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;FinDiffType&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;central&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;FunValCheck&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;on&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;MaxFunEvals&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e6</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;MaxIter&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e6</span><span class="p">);</span>

<span class="c">% [be,fval,~,output]=fminunc(@Objective_mle,be0,options,pos, X, consumer_id, yd, yt,...</span>
<span class="c">% R, w, eps_draw,eps0_draw,curve);</span>

<span class="p">[</span><span class="n">be</span><span class="p">,</span><span class="n">fval</span><span class="p">,</span><span class="o">~</span><span class="p">,</span><span class="n">output</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fmincon</span><span class="p">(@</span><span class="n">Objective_mle</span><span class="p">,</span><span class="n">be0</span><span class="p">,[],[],[],[],</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">,[],</span><span class="n">options</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">eps_draw</span><span class="p">,</span><span class="n">eps0_draw</span><span class="p">,</span><span class="n">curve</span><span class="p">);</span>

<span class="n">be</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">be</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">be</span><span class="p">)]);</span>

<span class="n">ll_optim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">liklOutsideFE</span><span class="p">(</span><span class="n">be</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="n">eps_draw</span><span class="p">,</span><span class="n">eps0_draw</span><span class="p">,</span><span class="n">curve</span><span class="p">);</span>

<span class="n">G</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">ll_optim</span><span class="p">),</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">be</span><span class="p">));</span>
<span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">be</span><span class="p">)</span>
<span class="w">    </span><span class="n">par_input</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">be</span><span class="p">;</span>
<span class="w">    </span><span class="n">par_input</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">par_input</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">;</span>
<span class="w">    </span><span class="n">ll_j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">liklOutsideFE</span><span class="p">(</span><span class="n">par_input</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="n">eps_draw</span><span class="p">,</span><span class="n">eps0_draw</span><span class="p">,</span><span class="n">curve</span><span class="p">);</span>
<span class="w">    </span><span class="n">G</span><span class="p">(:,</span><span class="w"> </span><span class="nb">j</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">ll_j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ll_optim</span><span class="p">)</span><span class="o">/</span><span class="mf">1e-3</span><span class="p">;</span>
<span class="k">end</span>

<span class="n">se</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">diag</span><span class="p">(</span><span class="nb">inv</span><span class="p">(</span><span class="n">G</span><span class="o">&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="p">)));</span>

<span class="n">se</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">se</span><span class="p">)]);</span>

<span class="nb">toc</span><span class="p">;</span>
<span class="n">mle_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">toc</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>

<span class="n">A</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">be</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">funcCount</span><span class="w"> </span><span class="n">fval</span><span class="w"> </span><span class="n">mle_time</span><span class="p">];</span>

<span class="n">csvwrite</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;theta_R%d_w%d.csv&#39;</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="o">-</span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="n">A</span><span class="p">);</span>
</pre></div>
</div>
</details><div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nne-estimation">NNE estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#moments-m"><code class="docutils literal notranslate"><span class="pre">Moments.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#predsummary-m"><code class="docutils literal notranslate"><span class="pre">PredSummary.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#statistics-m"><code class="docutils literal notranslate"><span class="pre">Statistics.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gen-seq-search-m"><code class="docutils literal notranslate"><span class="pre">gen_seq_search.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalregressionlayer-m"><code class="docutils literal notranslate"><span class="pre">normalRegressionLayer.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#positivetransform-m"><code class="docutils literal notranslate"><span class="pre">PositiveTransform.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-m"><code class="docutils literal notranslate"><span class="pre">set_up.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tabledata-csv"><code class="docutils literal notranslate"><span class="pre">tableData.csv</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smle-estimation">SMLE estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#likloutsidefe-m"><code class="docutils literal notranslate"><span class="pre">liklOutsideFE.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#objective-mle-m"><code class="docutils literal notranslate"><span class="pre">Objective_mle.m</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-mle-m"><code class="docutils literal notranslate"><span class="pre">main_mle.m</span></code></a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../_sources/code/code.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=927b94d3fcb96560df09"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=927b94d3fcb96560df09"></script>

<footer class="bd-footer">
  <div class="bd-footer__inner bd-page-width">
    <div class="footer-items__start">    
        <div class="footer-item">
          <p>© Copyright 2023, <a href="https://sites.google.com/site/yanhaomaxwei/" target="_blank">Yanhao "Max" Wei</a>, 
                                <a href="https://jiangzhenling.com/" target="_blank">Zhenling Jiang </a>.</p>
    </div>                      
  </div>
</footer>

  </body>
</html>